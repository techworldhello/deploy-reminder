package webhook_parser

import (
	"testing"
)

func TestParserWorks(t *testing.T) {
	b := NewBuildKite()
	if err := b.Parse(dummyWebhook); err != nil {
		t.Errorf("error parsing event: %+v", err)
	}
}

const dummyWebhook = `{"event":"job.finished","job":{"id":"c8921946-4797-4437-b08c-75b79bb09ce2","type":"script","name":":llama:","step_key":null,"agent_query_rules":[],"state":"passed","build_url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test/builds/5","web_url":"https://buildkite.com/doe-company/webhook-test/builds/5#c8921946-4797-4437-b08c-75b79bb09ce2","log_url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test/builds/5/jobs/c8921946-4797-4437-b08c-75b79bb09ce2/log","raw_log_url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test/builds/5/jobs/c8921946-4797-4437-b08c-75b79bb09ce2/log.txt","artifacts_url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test/builds/5/jobs/c8921946-4797-4437-b08c-75b79bb09ce2/artifacts","command":"buildkite-agent pipeline upload","soft_failed":false,"exit_status":0,"artifact_paths":"","agent":{"id":"faaf52d6-2d00-4c7e-a9e8-57fcd37f0ecf","url":"https://api.buildkite.com/v2/organizations/doe-company/agents/faaf52d6-2d00-4c7e-a9e8-57fcd37f0ecf","web_url":"https://buildkite.com/organizations/doe-company/agents/faaf52d6-2d00-4c7e-a9e8-57fcd37f0ecf","name":"76d17dc8d368-1","connection_state":"connected","ip_address":"158.140.215.12","hostname":"76d17dc8d368","user_agent":"buildkite-agent/3.23.1.x (linux; amd64)","version":"3.23.1","creator":null,"created_at":"2020-09-20T03:04:03.640Z","job":null,"last_job_finished_at":"2020-09-20T03:24:45.000Z","priority":0,"meta_data":[]},"created_at":"2020-09-20T03:24:38.888Z","scheduled_at":"2020-09-20T03:24:38.888Z","runnable_at":"2020-09-20T03:24:38.000Z","started_at":"2020-09-20T03:24:40.444Z","finished_at":"2020-09-20T03:24:45.486Z","retried":false,"retried_in_job_id":null,"retries_count":null,"parallel_group_index":null,"parallel_group_total":null},"build":{"id":"a921be81-fcdf-4486-83c7-8f0a8beffc2d","url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test/builds/5","web_url":"https://buildkite.com/doe-company/webhook-test/builds/5","number":5,"state":"running","blocked":false,"blocked_state":"","message":"tset webshoo","commit":"173486972072fbb85bfca5a6332e3026a2389df9","branch":"master","tag":null,"source":"ui","author":null,"creator":{"id":"c3a638ce-1e66-4898-8a6d-250cde55035f","name":"Mr Doe","email":"doe@doe.com","avatar_url":"https://www.gravatar.com/avatar/f559ca23885b668f9cad71f58fbfdcc7","created_at":"2020-09-20T02:48:14.406Z"},"created_at":"2020-09-20T03:24:38.880Z","scheduled_at":"2020-09-20T03:24:38.862Z","started_at":"2020-09-20T03:24:40.000Z","finished_at":null,"meta_data":{"buildkite:git:commit":"commit 173486972072fbb85bfca5a6332e3026a2389df9\nAuthor:     Jane \u003cjane@doe.com\u003e\nAuthorDate: Sun Sep 20 13:10:10 2020 +1000\nCommit:     Jane \u003cjane@doe.com\u003e\nCommitDate: Sun Sep 20 13:18:34 2020 +1000\n\n    test basic pipeline"},"pull_request":null,"rebuilt_from":null},"pipeline":{"id":"5c543cdf-7231-460d-9048-f6d5e1bbabf5","url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test","web_url":"https://buildkite.com/doe-company/webhook-test","name":"webhook test","description":null,"slug":"webhook-test","repository":"https://github.com/techworldhello/deploy-reminder.git","cluster_id":null,"branch_configuration":null,"default_branch":"master","skip_queued_branch_builds":false,"skip_queued_branch_builds_filter":null,"cancel_running_branch_builds":false,"cancel_running_branch_builds_filter":null,"provider":{"id":"github","settings":{"trigger_mode":"code","build_pull_requests":true,"pull_request_branch_filter_enabled":false,"skip_builds_for_existing_commits":false,"skip_pull_request_builds_for_existing_commits":true,"build_pull_request_forks":false,"build_pull_request_ready_for_review":false,"prefix_pull_request_fork_branch_names":true,"build_branches":true,"build_tags":false,"cancel_deleted_branch_builds":false,"publish_commit_status":true,"publish_commit_status_per_step":false,"separate_pull_request_statuses":false,"publish_blocked_as_pending":false,"filter_enabled":false,"repository":"techworldhello/deploy-reminder"},"webhook_url":"https://webhook.buildkite.com/deliver/bf7617591288f1c60f3453ed5f202ba20d57dcf875c39403fd"},"builds_url":"https://api.buildkite.com/v2/organizations/doe-company/pipelines/webhook-test/builds","badge_url":"https://badge.buildkite.com/7c6a9cb1d54780ab3452ad9950e8d14f351ba6cd2e0a6fd8be.svg","created_at":"2020-09-20T03:00:27.354Z","env":{},"scheduled_builds_count":0,"running_builds_count":1,"scheduled_jobs_count":1,"running_jobs_count":1,"waiting_jobs_count":1,"visibility":"private","steps":[{"type":"script","name":":llama:","command":"buildkite-agent pipeline upload","artifact_paths":"","branch_configuration":"","env":{},"timeout_in_minutes":null,"agent_query_rules":[],"concurrency":null,"parallelism":null}]},"sender":{"id":"c3a638ce-1e66-4898-8a6d-250cde55035f","name":"Mr Doe"}}`